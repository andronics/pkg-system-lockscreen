#!/usr/bin/env zsh

name=$(basename "$0")

# ------------------------------

source "$(which _common)" >/dev/null 2>&1 || true
source "$(which _log)"
source "$(which _systemd)"
source "$(which _xidlehook)"
source "$(which _xdg)" >/dev/null 2>&1 || true

# ------------------------------

# Setup XDG directories using extension library
xdg-setup-dirs "${name}"

# Backward-compatible aliases
lockscreen_cache_dir="${XDG_CACHE_DIR}"
lockscreen_config_dir="${XDG_CONFIG_DIR}"
lockscreen_data_dir="${XDG_DATA_DIR}"

# ------------------------------

lockscreen_wallpaper="${XDG_CONFIG_HOME}/.local/share/backgrounds/0001.png"

# ------------------------------

source "$(which _args)"

# ------------------------------

_lockscreen() {


    [[ $# -eq 0 ]] && {
        log-error "command not specified"
        return 1
    }

    _command=$1
    shift 2>/dev/null

    case "${_command}" in

        hook-delete) _lockscreen_hook_delete "$@" ;;
        hook-disable) _lockscreen_hook_disable "$@" ;;
        hook-enable) _lockscreen_hook_enable "$@" ;;
        hook-idle) _lockscreen_hook_idle $*;;
        hook-init) _lockscreen_hook_init $*;;
        hook-query) _lockscreen_hook_query "$@" ;;
        hook-trigger) _lockscreen_hook_trigger "$@" ;;
        
        service-install) _lockscreen_service_install "$@" ;;
        service-restart) _lockscreen_service_restart "$@" ;;
        service-start) _lockscreen_service_start "$@" ;;
        service-status) _lockscreen_service_status "$@" ;;
        service-stop) __lockscreen_service_stop "$@" ;;
        service-uninstall) _lockscreen_service_uninstall "$@" ;;

        state-activate) _lockscreen_state_activate "$@" ;;
        
        wallpaper-update) _lockscreen_wallpaper_update "$@" ;;

        *) log-warning "command '%s' unsupported" "${_command}" ;;

    esac

}

# ------------------------------

_lockscreen_state_activate() {
    
    betterlockscreen --lock -- -n

}

# ------------------------------

_lockscreen_hook_delete() {
     
     _xidlehook_delete $*

}

_lockscreen_hook_disable() {
     
     _xidlehook_disable $*

}

_lockscreen_hook_enable() {
     
     _xidlehook_enable $*

}

_lockscreen_hook_idle() {
     
     _xidlehook_idle $*

}

_lockscreen_hook_init() {
     
     _xidlehook_init "$0 state-activate"

}

_lockscreen_hook_query() {
     
     _xidlehook_query $*

}

_lockscreen_hook_trigger() {
     
     _xidlehook_trigger $*

}

# ------------------------------

_lockscreen_service_install() {
    log-info "installing lockscreen service"

    # Reload systemd daemon to pick up new service file
    systemd-daemon-reload "--user"

    # Enable and start the service
    systemd-enable-start "lockscreen" "--user"
}

_lockscreen_service_restart() {
    log-info "restarting lockscreen service"
    systemd-restart "lockscreen" "--user"
}

_lockscreen_service_start() {
    log-info "starting lockscreen service"
    systemd-start "lockscreen" "--user"
}

_lockscreen_service_status() {
    systemd-get-status "lockscreen" "--user"
}

_lockscreen_service_stop() {
    log-info "stopping lockscreen service"
    systemd-stop "lockscreen" "--user"
}

_lockscreen_service_uninstall() {
    log-info "uninstalling lockscreen service"

    # Stop and disable the service
    systemd-disable-stop "lockscreen" "--user"

    # Reload systemd daemon
    systemd-daemon-reload "--user"
}

# ------------------------------

_lockscreen_wallpaper_update() {

    log-info "updating lockscreen image"
    betterlockscreen --update "${lockscreen_wallpaper}"

}

# ------------------------------

_lockscreen "$@"
